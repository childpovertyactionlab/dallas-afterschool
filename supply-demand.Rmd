---
title: "Supply and Demand Index"
output:
  distill::distill_article:
    toc: TRUE
    theme: theme.css
---

## Topline results
[Description of both indexes and results]

```{r Set-Up Block, include = FALSE}
##### Load Libraries #####
library(tidyverse)
library(sf)
library(leaflet)
library(mapboxapi)
library(htmltools)
library(CPALtools)

#### Load CRED Locations #####
dallasCounty <- st_read(here::here("data/dallasCounty.geojson")) %>%
  st_transform(crs = 4269)

dasDemo <- st_read(here::here("data/ACS Demographic Metrics.geojson")) %>%
  st_transform(crs = 4269)

dasComponents <- st_read(here::here("data/dasComponents.geojson")) %>%
  st_transform(crs = 4269) %>%
  mutate(IndexGroup = ifelse(DesertBrks == "[ -58, -34 ]", "Extreme Need", 
                             ifelse(DesertBrks ==  "(-34,-11]", "High Need", 
                                    ifelse(DesertBrks ==  "(-11,15]", "Moderate Need", 
                                           ifelse(DesertBrks == "(15,50]", "Moderate Excess", 
                                                  ifelse(DesertBrks == "(50,98]", "High Excess", 
                                                         ifelse(is.na(DesertBrks), NA, "ERROR")))))))

desert_en <- dasComponents %>%
  filter(IndexGroup == "Extreme Need")
```

## Supply and Demand in Dallas County
[Map showing indexes by census tract]

[Include label popups for demographic information]

```{r, Component Index, echo = FALSE, message=FALSE, warning=FALSE, layout="l-page", fig.height=8}
#names(dasDemo)
popup <- paste0("<b>", "GEOID: ", "</b>", dasDemo$GEOID, "<br>",
               "<b>", "Median Household Income: ", "</b>", "$", dasDemo$mhiE, "<br>",
               "<b>", "Total Population: ", "</b>", dasDemo$tot_popE, "<br>",
               "<b>", "Asian (%): ", "</b>", round(dasDemo$as_per*100, digits =1), "%", "<br>",
               "<b>", "Black (%): ", "</b>", round(dasDemo$bl_per*100, digits =1), "%", "<br>",
               "<b>", "Hispanic (%) : ", "</b>", round(dasDemo$hi_per*100, digits =1), "%", "<br>",
               "<b>", "White (%): ", "</b>", round(dasDemo$wh_per*100, digits =1), "%", "<br>",
               "<b>", "Child Poverty Rate (u18): ", "</b>", round(dasDemo$cpr*100, digits =1), "%", "<br>",
               "<b>", "Internet Access (%): ", "</b>", round(dasDemo$int_per*100, digits =1), "%", "<br>",
               "<b>", "Single-Mother Households (%): ", "</b>", round(dasDemo$smhh_per*100, digits =1), "%", "<br>",
               "<b>", "Single-Mother Households Below Poverty (%): ", "</b>", round(dasDemo$smhh_bpE*100, digits =1), "%", "<br>",
               "<b>", "Unemployment Rate: ", "</b>", round(dasDemo$unemE*100, digits =1), "%"
               )

brksSupply <- BAMMtools::getJenksBreaks(dasComponents$indexSupply, k = 6)
brksDemand <- BAMMtools::getJenksBreaks(dasComponents$indexDemand, k = 6)

palSupply <- colorBin("PuBu", domain = dasComponents$indexSupply, bins = brksSupply)
palDemand <- colorBin("OrRd", domain = dasComponents$indexDemand, bins = brksDemand)

leaflet() %>%
#  setView(lng = -96.7970, lat = 32.7767, zoom = 10) %>%
  addTiles(urlTemplate = cpal_mapbox, attribution = cpal_leaflet) %>%
  addPolygons(data = dasComponents,
              fillColor = ~palDemand(indexDemand),
              weight = 1,
              opacity = 1,
              color = "#686158",
              #dashArray = "3",
              fillOpacity = 0.6,
              group = "Demand Component",
              popup = ~popup
              ) %>%
  addPolygons(data = dasComponents,
              fillColor = ~palSupply(indexSupply),
              weight = 1,
              opacity = 1,
              color = "#686158",
              #dashArray = "3",
              fillOpacity = 0.6,
              group = "Supply Component",
              popup = ~popup
              ) %>%
  addPolygons(data = desert_en,
              weight = 2,
              opacity = 1,
              color = "red",
              #dashArray = "3",
              fillOpacity = 0,
              group = "Extreme Need"
              ) %>%
  addPolygons(data = dallasCounty,
              color = "#686158",
              weight = 3,
              smoothFactor = 0.2, 
              fillOpacity = 0,
              group = "Dallas County"
              ) %>%
  addLegend(data = dasComponents,
            "bottomright", 
            pal = palDemand, 
            values = ~indexDemand,
            title = "Demand Index",
            group = "Demand Component",
            #labFormat = labelFormat(prefix = "$"),
            opacity = 1) %>%
  addLegend(data = dasComponents,
            "bottomright", 
            pal = palSupply, 
            values = ~indexSupply,
            title = "Supply Index",
            group = "Supply Component",
            #labFormat = labelFormat(prefix = "$"),
            opacity = 1) %>%

  addLayersControl(
    overlayGroups = c("Demand Component", "Supply Component", "Extreme Need"),
    baseGroups = c("Dallas County"),
    position = "topright",
    options = layersControlOptions(collapsed = FALSE)) %>% 
  hideGroup("Extreme Need")
```

## Afterschool Program Access
[Summaries and charts detailing the analysis and the types of people affected by low program supply.]