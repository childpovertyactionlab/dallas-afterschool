---
title: "Dallas County Supply and Demand Scores"
output:
  distill::distill_article:
    toc: TRUE
    theme: theme.css
---

The map below visualizes the supply and demand scores for each census tract. By toggling the layer selection on the top right of the map you will be able to view each score. By clicking on any given census tract a popup will appear as well displaying a variety of demographic metrics of interest including race/ethnicity, income, and employment characteristics.

```{r, Component Index, echo = FALSE, message=FALSE, warning=FALSE, layout="l-body", fig.height=6}
pal_das <- c("#DC5034", "#0089C4", "#FFB533", "#ADB533", "#8078B6", "#8996A0", "#54494B")
#names(dasDemo)
popup <- paste0("<b>", "GEOID: ", "</b>", dasDemo$GEOID, "<br>",
               "<b>", "Median Household Income: ", "</b>", scales::dollar(dasDemo$mhiE), "<br>",
               "<b>", "Total Population: ", "</b>", scales::comma(round(dasDemo$tot_popE, digits = 0)), "<br>",
               "<b>", "Asian (%): ", "</b>", round(dasDemo$as_per*100, digits =1), "%", "<br>",
               "<b>", "Black (%): ", "</b>", round(dasDemo$bl_per*100, digits =1), "%", "<br>",
               "<b>", "Hispanic (%) : ", "</b>", round(dasDemo$hi_per*100, digits =1), "%", "<br>",
               "<b>", "White (%): ", "</b>", round(dasDemo$wh_per*100, digits =1), "%", "<br>",
               "<b>", "Child Poverty Rate: ", "</b>", round(dasDemo$cpr*100, digits =1), "%", "<br>",
               "<b>", "Internet Access (%): ", "</b>", round(dasDemo$int_per*100, digits =1), "%", "<br>",
               "<b>", "Single-Mom Households (%): ", "</b>", round(dasDemo$smhh_per*100, digits =1), "%", "<br>",
               "<b>", "Single-Mom Households Below Poverty (%): ", "</b>", round(dasDemo$smhh_bpE*100, digits =1), "%", "<br>",
               "<b>", "Unemployment Rate: ", "</b>", round(dasDemo$unemE*100, digits =1), "%"
               )

brksSupply <- BAMMtools::getJenksBreaks(dasComponents$indexSupply, k = 6)
brksDemand <- BAMMtools::getJenksBreaks(dasComponents$indexDemand, k = 6)

palSupply <- colorBin("BuPu", domain = dasComponents$indexSupply, bins = brksSupply)
palDemand <- colorBin("RdPu", domain = dasComponents$indexDemand, bins = brksDemand)

leaflet() %>%
#  setView(lng = -96.7970, lat = 32.7767, zoom = 10) %>%
  addTiles(urlTemplate = cpal_mapbox, attribution = cpal_leaflet) %>%
  addPolygons(data = dasComponents,
              fillColor = ~palDemand(indexDemand),
              weight = 1,
              opacity = 1,
              color = ~palDemand(indexDemand),#"#686158",
              #dashArray = "3",
              fillOpacity = 0.6,
              group = "Demand Score",
              popup = ~popup
              ) %>%
  addPolygons(data = dasComponents,
              fillColor = ~palSupply(indexSupply),
              weight = 1,
              opacity = 1,
              color = ~palSupply(indexSupply), #"#686158",
              #dashArray = "3",
              fillOpacity = 0.6,
              group = "Supply Score",
              popup = ~popup
              ) %>%
  addPolygons(data = dallasCounty,
              color = "#686158",
              weight = 3,
              smoothFactor = 0.2, 
              fillOpacity = 0,
              group = "Dallas County"
              ) %>%
  addPolygons(data = highways,
              color = "#686158",
              weight = 2,
              smoothFactor = 0.2, 
              fillOpacity = 0,
              group = "Dallas County"
              ) %>%
  addLegend(data = dasComponents,
            "bottomright", 
            pal = palDemand, 
            values = ~indexDemand,
            title = "Demand Score",
            group = "Demand Score",
            #labFormat = labelFormat(prefix = "$"),
            opacity = 1) %>%
  addLegend(data = dasComponents,
            "bottomright", 
            pal = palSupply, 
            values = ~indexSupply,
            title = "Supply Score",
            group = "Supply Score",
            #labFormat = labelFormat(prefix = "$"),
            opacity = 1) %>%
  addLayersControl(
    overlayGroups = c("Dallas County", "Demand Score", "Supply Score"),
#    baseGroups = c("Dallas County"),
    position = "topright",
    options = layersControlOptions(collapsed = FALSE)) %>% 
  hideGroup("Demand Score")
```

## Supply and Demand in Dallas County

This analysis has revealed that the supply of afterschool programming in Dallas County is highly concentrated into certain communities. About half of all census tracts in Dallas County received a score of 75 or greater on supply. These 379 census tracts contained 95% of all afterschool programs in  the county, while only being accessible to 63% (240,602) of eligible children.
Meanwhile, very few census tracts scored low on demand, with only 24 census tracts receiving a score less than 50 accounting for about 13,626 eligible children across Dallas County. Our analysis reveals that the demand for afterschool programming is consistently high across all communities across the county. 

```{r, Supply Scores Histogram, echo = FALSE, message=FALSE, warning=FALSE, include=FALSE}
dasmetrics %>%
  st_drop_geometry(.) %>%
  filter(indexSupply >= 75) %>%
  summarize(count = n(),
            programs = sum(dasPrograms),
            seats = sum(dasSeats),
            eligpop = sum(eligPop))

857/903

240602/sum(dasmetrics$eligPop)

dasComponents %>%
  ggplot(aes(x = indexSupply)) +
  geom_histogram(bins = 50, color = "#0089C4", fill = "#0089C4", alpha = 0.7) +
  labs(title = "Distribution of Supply Scores",
       #subtitle = "U.S. Census Bureau, American Community Survey 5-Year Estimates 2020",
       x = "Supply Score",
       y = "Total Census Tracts",
       color = "") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.key.width = unit(0.5, units = "in"),
        plot.caption = element_text(size = 36, face = "italic"),
        legend.spacing = unit(0, "in"), 
        legend.key.height = unit(0.25, "in"), 
        legend.spacing.x = unit(0.1, "in"), 
        legend.justification = "center",
        legend.margin=margin(4,4,4,4),
        legend.box.spacing = margin(0.5))
```



```{r, Demand Scores Histogram, echo = FALSE, message=FALSE, warning=FALSE, include=FALSE}
dasComponents %>%
  ggplot(aes(x = indexDemand)) +
  geom_histogram(bins = 50, color = "#DC5034", fill = "#DC5034", alpha = 0.7) +
  labs(title = "Distribution of Demand Scores",
       #subtitle = "U.S. Census Bureau, American Community Survey 5-Year Estimates 2020",
       x = "Demand Score",
       y = "Total Census Tracts",
       color = "") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.key.width = unit(0.5, units = "in"),
        plot.caption = element_text(size = 36, face = "italic"),
        legend.spacing = unit(0, "in"), 
        legend.key.height = unit(0.25, "in"), 
        legend.spacing.x = unit(0.1, "in"), 
        legend.justification = "center",
        legend.margin=margin(4,4,4,4),
        legend.box.spacing = margin(0.5))

dasmetrics %>%
  st_drop_geometry(.) %>%
  filter(indexDemand <= 50) %>%
  summarize(count = n(),
            programs = sum(dasPrograms),
            seats = sum(dasSeats),
            eligpop = sum(eligPop))
```

## Why are we using scores?

The afterschool environment is dynamic. Programs may open or close, add or remove seats based on changes in staffing or other external factors, or change location at almost any time. Dallas Afterschool monitors the overall afterschool landscape, but specific changes are not always available in real time. Additionally, the characteristics of local communities, measured by the U.S. Census Bureau, are based on a relatively small - but robust - sample of the population. Given the changing nature of the afterschool environment, COVID's impact may not be reflected in the underlying census data used to assess the need for afterschool programming.  

As a result, our intention is not to identify the exact number of afterschool seats needed to address unmet demand. For example, data could indicate that a program has capacity for 50 students, but will not show if a program has a waitlist. To account for this gap, we developed two sets of scores to measure the relative position of a neighborhood's afterschool environment: 1) the supply of seats and programs and 2) the potential need or demand for afterschool programming based on population characteristics. 

We assessed these two components through the creation of two indices, which produced scores ranging from 0 to 100. A census tract with a Supply Score of 58 suggests that this particular location falls in the middle when it comes to the availability of afterschool programs and seats.

## What the scores are not

The methodology used to generate the supply and demand scores analyzes areas of the county where additional afterschool programming may have an outsized impact in providing children with additional enrichment opportunities and adult supervision.

The demand score includes demographic characteristics metrics related to eligible population, single-mother households, household income, child poverty rate, SNAP receiving households, and transportation accessibility weighted against one another. Whereas the supply score was assessed using a  combination of program density, eligible population, total program count, and total number of seats.  were then  identified based on where each metric most commonly interacts. 

Because these characteristics can often overlap, it is important to note that we are not generating an exact seat count. These scores are relative measures of today's landscape. They identify where there are opportunities for program expansion given what we know about  the afterschool environment.
