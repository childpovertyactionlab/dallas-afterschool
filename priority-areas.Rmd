---
title: "Priority Areas"
output:
  distill::distill_article:
    toc: TRUE
    theme: theme.css
---

```{r Set-Up Block, include = FALSE}
# generate table by group
typologytable <- dasmetrics %>%
  st_drop_geometry(.) %>%
  group_by(Typology) %>%
  summarise(TotalTracts = n(),
            AreaSqMi = sum(AreaSqMi),
            mhi = median(med_incE),
            eligPop = sum(eligPop),
            bp_u18 = sum(bp_u18E, na.rm = TRUE),
            pop_u18 = sum(pop_u18E, na.rm = TRUE),
            dasPrograms = sum(dasPrograms),
            dasSeats = sum(dasSeats),
            cacfpPrograms = sum(cacfpPrograms),
            cacfpSeats = sum(cacfpSeats),
            hhsPrograms = sum(hhsPrograms),
            hhsSeats = sum(hhsSeats),
            totPrograms = sum(dasPrograms+cacfpPrograms+hhsPrograms),
            totSeats = sum(dasSeats+cacfpSeats+hhsSeats)) %>%
  mutate(poppro = round(eligPop/totSeats, digits = 3),
         cpr = round(bp_u18/pop_u18, digits = 3)) %>%
  select(-(cacfpPrograms:hhsSeats))

typeSupply <- dasmetrics %>%
  st_drop_geometry(.) %>%
  group_by(typeSupply) %>%
  dplyr::summarise(Supply = n()) %>%
  mutate(typeSupply = str_remove(typeSupply, " SUPPLY")) %>%
  rename(Classification = typeSupply)

typeDemand <- dasmetrics %>%
  st_drop_geometry(.) %>%
  group_by(typeDemand) %>%
  dplyr::summarise(Demand = n()) %>%
  mutate(typeDemand = str_remove(typeDemand, " DEMAND")) %>%
  rename(Classification = typeDemand)

typeJoin <- left_join(typeSupply, typeDemand) %>%
  mutate(Order = ifelse(Classification == "HIGH", 1, 
                        ifelse(Classification == "MOD HIGH", 2, 
                               ifelse(Classification == "MOD LOW", 3, 
                                      ifelse(Classification == "LOW", 4, "ERROR"))))) %>%
    mutate(Classification = ifelse(Classification == "HIGH", "High", 
                        ifelse(Classification == "MOD HIGH", "Moderate High", 
                               ifelse(Classification == "MOD LOW", "Moderate Low", 
                                      ifelse(Classification == "LOW", "Low", "ERROR")))))

#unique(das_metrics$Typology)
HS_LD <- dasmetrics %>%
  filter(Typology == "HIGH SUPPLY - LOW DEMAND")

HS_MLD <- dasmetrics %>%
  filter(Typology == "HIGH SUPPLY - MOD LOW DEMAND")

MHS_HD <- dasmetrics %>%
  filter(Typology == "MOD HIGH SUPPLY - HIGH DEMAND")

MHS_LD <- dasmetrics %>%
  filter(Typology == "MOD HIGH SUPPLY - LOW DEMAND")

MHS_MHD <- dasmetrics %>%
  filter(Typology == "MOD HIGH SUPPLY - MOD HIGH DEMAND")

MHS_MLD <- dasmetrics %>%
  filter(Typology == "MOD HIGH SUPPLY - MOD LOW DEMAND")

MLS_HD <- dasmetrics %>%
  filter(Typology == "MOD LOW SUPPLY - HIGH DEMAND")

MLS_LD <- dasmetrics %>%
  filter(Typology == "MOD LOW SUPPLY - LOW DEMAND")

MLS_MHD <- dasmetrics %>%
  filter(Typology == "MOD LOW SUPPLY - MOD HIGH DEMAND")

MLS_MLD <- dasmetrics %>%
  filter(Typology == "MOD LOW SUPPLY - MOD LOW DEMAND")

LS_LD <- dasmetrics %>%
  filter(Typology == "LOW SUPPLY - LOW DEMAND")

LS_MLD <- dasmetrics %>%
  filter(Typology == "LOW SUPPLY - MOD LOW DEMAND")

```
## Typology of Program Access

In order to assess what census tracts have the highest demand for afterschool programs relative to current supply, each index was classified into one of four groups based on their score.

**Total Census Tracts for Each Classification**

```{r, echo = FALSE, message=FALSE, warning=FALSE, layout="l-body", fig.height=8}
typeJoin %>%
  arrange(Order) %>%
  select(-Order) %>%
  knitr::kable(.)
```

These groups were then compared against one another in order to identify areas of the county with high demand for afterschool programs relative to the current supply. With this analysis **21** census tracts were identified as having Moderate Low Supply to Moderate High Demand, and **11** census tracts were identified as having Moderate Low Supply to High Demand.

[ggplot2 scatterplot and table visualizing each typology and counts of tracts.]

```{r Typology Leaflet Map, echo = FALSE, message=FALSE, warning=FALSE, layout="l-page", fig.height=8}
leaflet() %>%
#  setView(lng = -96.7970, lat = 32.7767, zoom = 10) %>%
  addTiles(urlTemplate = cpal_mapbox, attribution = cpal_leaflet) %>%
    addPolygons(data = HS_LD,
              fillColor = "blue",
              weight = 1,
              opacity = 1,
              color = "blue",
              fillOpacity = 0.7,
              group = "High Supply - Low Demand"
              ) %>%
  addPolygons(data = HS_MLD,
              fillColor = "blue",
              weight = 1,
              opacity = 1,
              color = "blue",
              fillOpacity = 0.7,
              group = "High Supply - Mod Low Demand"
              ) %>%
  addPolygons(data = LS_LD,
              fillColor = "cyan",
              weight = 1,
              opacity = 1,
              color = "cyan",
              fillOpacity = 0.7,
              group = "Low Supply - Low Demand"
              ) %>%
  addPolygons(data = LS_MLD,
              fillColor = "orange",
              weight = 1,
              opacity = 1,
              color = "orange",
              fillOpacity = 0.7,
              group = "Low Supply - Mod Low Demand"
              ) %>%
  addPolygons(data = MHS_HD,
              fillColor = "orange",
              weight = 1,
              opacity = 1,
              color = "orange",
              fillOpacity = 0.7,
              group = "Mod High Supply - High Demand"
              ) %>%
  addPolygons(data = MHS_LD,
              fillColor = "blue",
              weight = 1,
              opacity = 1,
              color = "blue",
              fillOpacity = 0.7,
              group = "Mod High Supply - Low Demand"
              ) %>%
  addPolygons(data = MHS_MHD,
              fillColor = "cyan",
              weight = 1,
              opacity = 1,
              color = "cyan",
              fillOpacity = 0.7,
              group = "Mod High Supply - Mod High Demand"
              ) %>%
  addPolygons(data = MHS_MLD,
              fillColor = "blue",
              weight = 1,
              opacity = 1,
              color = "blue",
              fillOpacity = 0.7,
              group = "Mod High Supply - Mod Low Demand"
              ) %>%
  addPolygons(data = MLS_HD,
              fillColor = "red",
              weight = 1,
              opacity = 1,
              color = "red",
              fillOpacity = 0.7,
              group = "Mod Low Supply - High Demand"
              ) %>%
  addPolygons(data = MLS_LD,
              fillColor = "orange",
              weight = 1,
              opacity = 1,
              color = "orange",
              fillOpacity = 0.7,
              group = "Mod Low Supply - Low Demand"
              ) %>%
  addPolygons(data = MLS_MHD,
              fillColor = "red",
              weight = 1,
              opacity = 1,
              color = "red",
              fillOpacity = 0.7,
              group = "Mod Low Supply - Mod High Demand"
              ) %>%
  addPolygons(data = MLS_MLD,
              fillColor = "cyan",
              weight = 1,
              opacity = 1,
              color = "cyan",
              fillOpacity = 0.7,
              group = "Mod Low Supply - Mod Low Demand"
              ) %>%
    addPolygons(data = dallasCounty,
              color = "#686158",
              weight = 3,
              smoothFactor = 0.2, 
              fillOpacity = 0,
              group = "Dallas County"
              ) %>%
  addPolygons(data = citycouncil,
              color = "#686158",
              weight = 3,
              smoothFactor = 0.2, 
              fillOpacity = 0,
              group = "Dallas City Council"
              ) %>%
  addLayersControl(
    baseGroups = c("Dallas County"),
    overlayGroups = c("Dallas City Council", "Low Supply - Low Demand", "Low Supply - Mod Low Demand", 
                      "Mod Low Supply - Low Demand", "Mod Low Supply - Mod Low Demand", "Mod Low Supply - Mod High Demand", "Mod Low Supply - High Demand",
                      "Mod High Supply - Low Demand", "Mod High Supply - Mod Low Demand", "Mod High Supply - Mod High Demand", "Mod High Supply - High Demand",
                      "High Supply - Low Demand", "High Supply - Mod Low Demand"),
    position = "topright",
    options = layersControlOptions(collapsed = FALSE))
```
## Characteristics of Typology Groups
```{r, echo = FALSE, message=FALSE, warning=FALSE, layout="l-body-outset", fig.height=8}
typologytable %>%
  mutate(Typology = str_to_title(Typology),
         AreaSqMi = round(AreaSqMi),
         mhi = round(mhi),
         cpr = paste0(round(cpr*100, digits = 1), "%"),
         popden = round(eligPop/AreaSqMi))%>%
  select(-(pop_u18:dasSeats)) %>%
  knitr::kable(.,
               col.names = c('Typology', 'Total Tracts', 'Area SqMi', 'Median Household Income', 'Eligible Population', 'Below Poverty (Under 18)', 'Total Programs', 'Total Seats', 'Eligible to Seat Ratio', 'Child Poverty Rate', 'Eligible Density'))
```

## Recommendations for LOW-HIGH

[List of recommendations for LOW-HIGH typology]

## Insights on Other Typologies

[Any additional important insight for other typology groups, maybe unnecessary.]