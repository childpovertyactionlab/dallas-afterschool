---
title: "Highest Need Afterschool Priority Areas"
output:
  distill::distill_article:
    toc: TRUE
    theme: theme.css
---

```{r Set-Up Block, include = FALSE}
# generate table by group
typologytable <- dasmetrics %>%
  st_drop_geometry(.) %>%
  group_by(MainGrp) %>%
  summarise(TotalTracts = n(),
            AreaSqMi = sum(AreaSqMi),
            mhi = median(med_incE, na.rm = TRUE),
            eligPop = sum(eligPop),
            bp_u18 = sum(bp_u18E, na.rm = TRUE),
            pop_u18 = sum(pop_u18E, na.rm = TRUE),
            dasPrograms = sum(dasPrograms),
            dasSeats = sum(dasSeats),
            #cacfpPrograms = sum(cacfpPrograms),
            #cacfpSeats = sum(cacfpSeats),
            #hhsPrograms = sum(hhsPrograms),
            #hhsSeats = sum(hhsSeats),
            #totPrograms = sum(dasPrograms+cacfpPrograms+hhsPrograms),
            #totSeats = sum(dasSeats+cacfpSeats+hhsSeats)
            ) %>%
  mutate(poppro = round(eligPop/dasSeats, digits = 3),
         cpr = round(bp_u18/pop_u18, digits = 3))

typeSupply <- dasmetrics %>%
  st_drop_geometry(.) %>%
  group_by(typeSupply) %>%
  dplyr::summarise(Supply = n()) %>%
  #mutate(typeSupply = str_remove(typeSupply, " SUPPLY")) %>%
  rename(Classification = typeSupply)

typeDemand <- dasmetrics %>%
  st_drop_geometry(.) %>%
  group_by(typeDemand) %>%
  dplyr::summarise(Demand = n()) %>%
  #mutate(typeDemand = str_remove(typeDemand, " DEMAND")) %>%
  rename(Classification = typeDemand)

typeJoin <- left_join(typeSupply, typeDemand) %>%
  mutate(Demand = ifelse(is.na(Demand), 0, Demand),
         Supply = ifelse(is.na(Supply), 0, Supply),
         Order = ifelse(Classification == "VERY HIGH", 1, 
                        ifelse(Classification == "HIGH", 2, 
                               ifelse(Classification == "MODERATE", 3, 
                                      ifelse(Classification == "LOW", 4, 
                                             ifelse(Classification == "VERY LOW", 5, "ERROR")))))) %>%
    mutate(Classification = ifelse(Classification == "VERY HIGH", "Very High", 
                        ifelse(Classification == "HIGH", "High", 
                               ifelse(Classification == "MODERATE", "Moderate", 
                                      ifelse(Classification == "LOW", "Low", 
                                             ifelse(Classification == "VERY LOW", "Very Low", "ERROR"))))))

unique(dasmetrics$MainGrp)
dem_sup <- dasmetrics %>%
  filter(MainGrp == "Demand > Supply")

sup_dem <- dasmetrics %>%
  filter(MainGrp == "Demand < Supply")

demTsup <- dasmetrics %>%
  filter(MainGrp == "Demand = Supply")

priorityareas <- dasmetrics %>%
  filter(brkdiff == max(brkdiff, na.rm = TRUE))
```

## Afterschool Program Need in Dallas County
```{r Typology Leaflet Map, echo = FALSE, message=FALSE, warning=FALSE, layout="l-page", fig.height=8}
popup <- paste0("<b>", "GEOID: ", "</b>", dasDemo$GEOID, "<br>",
               "<b>", "Median Household Income: ", "</b>", scales::dollar(dasDemo$mhiE), "<br>",
               "<b>", "Total Population: ", "</b>", scales::comma(round(dasDemo$tot_popE, digits = 0)), "<br>",
               "<b>", "Asian (%): ", "</b>", round(dasDemo$as_per*100, digits =1), "%", "<br>",
               "<b>", "Black (%): ", "</b>", round(dasDemo$bl_per*100, digits =1), "%", "<br>",
               "<b>", "Hispanic (%) : ", "</b>", round(dasDemo$hi_per*100, digits =1), "%", "<br>",
               "<b>", "White (%): ", "</b>", round(dasDemo$wh_per*100, digits =1), "%", "<br>",
               "<b>", "Child Poverty Rate (u18): ", "</b>", round(dasDemo$cpr*100, digits =1), "%", "<br>",
               "<b>", "Internet Access (%): ", "</b>", round(dasDemo$int_per*100, digits =1), "%", "<br>",
               "<b>", "Single-Mother Households (%): ", "</b>", round(dasDemo$smhh_per*100, digits =1), "%", "<br>",
               "<b>", "Single-Mother Households Below Poverty (%): ", "</b>", round(dasDemo$smhh_bpE*100, digits =1), "%", "<br>",
               "<b>", "Unemployment Rate: ", "</b>", round(dasDemo$unemE*100, digits =1), "%"
               )


leaflet() %>%
#  setView(lng = -96.7970, lat = 32.7767, zoom = 10) %>%
  addTiles(urlTemplate = cpal_mapbox, attribution = cpal_leaflet) %>%
    addPolygons(data = priorityareas,
              fillColor = "#84301f",
              weight = 1,
              opacity = 1,
              color = "#84301f ",
              fillOpacity = 0.7,
              popup = ~popup,
              group = "Priority Areas"
              ) %>%
  addPolygons(data = dem_sup,
              fillColor = "#DC5034",
              weight = 1,
              opacity = 1,
              color = "#DC5034",
              fillOpacity = 0.7,
              popup = ~popup,
              group = "Demand Exceeds Supply"
              ) %>%
  addPolygons(data = demTsup,
              fillColor = "#8996A0",
              weight = 1,
              opacity = 1,
              color = "#8996A0",
              fillOpacity = 0.6,
              popup = ~popup,
              group = "Demand Meets Supply"
              ) %>%
  addPolygons(data = sup_dem,
              fillColor = "#0089C4",
              weight = 1,
              opacity = 1,
              color = "#0089C4",
              fillOpacity = 0.6,
              popup = ~popup,
              group = "Supply Exceeds Demand"
              ) %>%
    addPolygons(data = dallasCounty,
              color = "#686158",
              weight = 3,
              smoothFactor = 0.2, 
              fillOpacity = 0,
              opacity = 1,
              group = "Dallas County"
              ) %>%
  addPolygons(data = citycouncil,
              color = "#EDE8D5",
              weight = 3,
              smoothFactor = 0.2, 
              fillOpacity = 0,
              opacity = 1,
              group = "Dallas City Council",
              label = ~htmlEscape(name)
              ) %>%
  addLayersControl(
    baseGroups = c("Dallas County"),
    overlayGroups = c("Dallas City Council", "Priority Areas", "Demand Exceeds Supply", "Supply Exceeds Demand", "Demand Meets Supply"),
    position = "topright",
    options = layersControlOptions(collapsed = FALSE)) %>% 
  hideGroup(c("Demand Exceeds Supply", "Supply Exceeds Demand", "Demand Meets Supply", "Dallas City Council"))
```

## What each typology looks like

```{r, echo = FALSE, message=FALSE, warning=FALSE, layout="l-body-outset", fig.height=8}
typologytable %>%
  filter(!is.na(MainGrp)) %>%
  mutate(MainGrp = str_to_title(MainGrp),
         AreaSqMi = round(AreaSqMi),
         popden = round(eligPop/AreaSqMi),
         mhi = scales::dollar(round(mhi)),
         eligPop = scales::comma(eligPop),
         dasSeats = scales::comma(dasSeats),
         cpr = paste0(round(cpr*100, digits = 1), "%"),
         poppro = round(poppro, digits = 1)) %>%
  select(MainGrp, TotalTracts, AreaSqMi, mhi, eligPop, dasPrograms, dasSeats, poppro, cpr, popden) %>%
  knitr::kable(.,
               col.names = c('Typology', 'Total Tracts', 'Area SqMi', 'Median Household Income', 'Eligible Children', 'Total Programs', 'Total Seats', 'Eligible to Seat Ratio', 'Child Poverty Rate', 'Eligible Density')) %>%
  kable_styling()
```

## Typology of Program Access

In order to assess what census tracts have the highest demand for afterschool programs relative to current supply, each index was classified into one of five initial groups based on their score.

**Total Census Tracts for Each Classification**

```{r, echo = FALSE, message=FALSE, warning=FALSE, layout="l-body", fig.height=8}
typeJoin %>%
  arrange(Order) %>%
  select(-Order) %>%
  knitr::kable(.) %>%
  kable_styling()
```


## Primary Typologies

With our classification methods we were able to identify 12 unique categories of need for afterschool programming in Dallas County, which we further classified into three primary categories.

* Supply Exceeds Demand: A census tract where the supply score significantly exceeds the demand score. Census tracts in this category tend to have a higher number of program seats available relative to the eligible population.

* Demand Exceeds Supply: A census tract where the demand score significantly exceeds the supply score. Census tracts in this category tend to have a lower number of program seats available relative to the eligible population.

* Supply Meets Demand: A census tract where the supply score and demand score are similar to one another. Census tracts in this category tend to have a similar number of available program seats relative to the eligible population.
